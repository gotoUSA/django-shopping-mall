name: Django CI

# ì–¸ì œ ì‹¤í–‰í• ì§€ ì„¤ì •
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    # PostgreSQL ì„œë¹„ìŠ¤ (í…ŒìŠ¤íŠ¸ìš©)
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: shopping_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    # í™˜ê²½ë³€ìˆ˜ ì„¤ì • (job ë ˆë²¨)
    env:
      DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
      DJANGO_DEBUG: False
      DATABASE_ENGINE: django.db.backends.postgresql
      DATABASE_NAME: shopping_db
      DATABASE_USER: test_user
      DATABASE_PASSWORD: test_password
      DATABASE_HOST: localhost
      DATABASE_PORT: 5432
      REDIS_URL: redis://localhost:6379/0
      CELERY_BROKER_URL: redis://localhost:6379/0
      CELERY_RESULT_BACKEND: redis://localhost:6379/0
      TOSS_CLIENT_KEY: test_ck_fake_key
      TOSS_SECRET_KEY: test_sk_fake_key
      TOSS_WEBHOOK_SECRET: test_webhook_secret


    steps:
    # ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout code
      uses: actions/checkout@v4

    # Python ì„¤ì •
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'

    # ì˜ì¡´ì„± ì„¤ì¹˜
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt


    # ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
    - name: Run migrations
      run: |
        python manage.py migrate --noinput

    # í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì¸¡ì •
    - name: Run tests with coverage
      run: |
        pip install coverage pytest-cov
        echo "ğŸ” CPU ì •ë³´:"
        nproc
        echo "ğŸ“¦ pytest-xdist ë²„ì „:"
        pip show pytest-xdist | grep Version
        echo "ğŸš€ í…ŒìŠ¤íŠ¸ ì‹œì‘ (ë³‘ë ¬ ì‹¤í–‰)..."
        # -n autoëŠ” pyproject.tomlì— ì„¤ì •ë˜ì–´ ìˆìŒ (ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  ì½”ì–´ ì‚¬ìš©)
        pytest shopping/tests/ \
          --reuse-db \
          --cov=shopping \
          --cov-report=term-missing \
          --cov-report=xml \
          --cov-fail-under=0 \
          -vv \
          --dist loadscope

    # ì½”ë“œ ìŠ¤íƒ€ì¼ ì²´í¬ (ì„ íƒì‚¬í•­)
    - name: Lint with flake8
      run: |
        pip install flake8
        # ì—ëŸ¬ë§Œ ì²´í¬ (ê²½ê³ ëŠ” ë¬´ì‹œ)
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # ë³µì¡ë„ ì²´í¬ (10 ì´ìƒë§Œ)
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true
